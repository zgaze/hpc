## USE分析法

USE分析法是Brendan Gregg提出的一个分析系统性能的方法，它先提出问题，然后找寻答案。

USE分析法通过构建一个检查列表，然后针对每种资源，检查其使用率（Utilization）、饱和度（Saturation）和错误（Error），被用于快速识别资源瓶颈和错误。

**资源**
所有物理的计算机功能单元，例如CPU、磁盘、内存、总线等；有时候软件也可视为某种资源

**使用率（Utilization）**
资源忙于服务的平均时间，有时候也指还可以接受多少服务请求，比如CPU的使用率100%表示满载，不能接受更多计算任务。
利用率常常表示一段时间间隔内的百分比，例如磁盘的利用率达到90%。

100%的使用率通常意味着明显的瓶颈，可以通过检查饱和度进一步确认，高使用率（>70%）则可能成为问题，这是因为：
- 使用率一般是对一段时间测量的平均值，而高的平均值，则通常意味短时间利用率会达到100%，而这种满使用率会被高平均使用率掩盖
- 有些系统，例如磁盘，在工作中不能被中断，即使有更高优先级的工作，一旦它们的使用率达到70%，排队延时会变得更频繁和显著。

**饱和度（Saturation）**
资源有额外工作要做，资源不能正常服务的度，例如排队等待资源可用的情况。
饱和度常表示为队列长度，比如CPU执行队列长度为4。

**错误（Error）**
错误时间的计数，错误常导致性能降级，当错误模式是可恢复的时候，出错情况常被忽略。

虽然在一段长时间里平均使用率很低，但高使用率脉冲常常会引起饱和和性能问题。比如5分钟内CPU的使用率从来没超过80%，但可能其中的几秒，CPU使用率达到100%，这样还是会有性能问题。

一般而言，我们会把检查下面的这些资源：
- CPU：包括sockets（非网络编程的socket）、cores和硬件线程
- 主存：容量
- 网络接口
- 存储设备：i/o、容量
- 控制器：存储控制器、网卡
- 通信互联（Interconnects）：CPU、主存、I/O，Interconnects常常被忽略，这些通常不会是瓶颈，但一旦是瓶颈，可能除了升级硬件，可以做的也不多

对于CPU，我们一般度量使用率和饱和度
CPU使用率可以是单核使用率，也可以是系统范围的CPU使用率；而CPU饱和度指运行队列的长度或者调度时延，如果可运行的线程数多于硬件核心数，则这些可运行的线程会用一个可运行链表串起来，这个链表就是可运行队列，队列长度反应CPU核心数不能满足运行线程数的程度。

对于主存，使用率一般指系统级的可用内存量，可用内存量越少则越表示内存越紧缺，而饱和度指线程swapping或者paging。

对于存储设备，使用率指设备忙碌的时间占比，而饱和度指等待队列的长度。

**小结**
USE分析法是一个用于系统健康检查、识别瓶颈错误的简易策略，它可以在早期就实施，并能快速识别问题，但有时候，需要配合其他分析方法去找出深层次的问题。通过针对每种资源，分析其使用率、饱和度和错误，这样一般不会忽视任何明显的资源问题，通过这一步，只是找到瓶颈在哪一个方面，但如何优化，则需要更细致的分析。
