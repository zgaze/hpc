# 内存管理和优化

- 存储程序原理奠定了现代计算机的基础，将程序像数据一样存储在计算机内存，计算机一条接着一条指令执行指令。内存不仅存储数据，而且存储程序，是计算机系统的核心功能组件之一。
- 围绕局部性原理，计算机系统构建起“寄存器->缓存(SRAM)->内存(DRAM)->磁盘(HDD/SSD)”的存储层次结构：离CPU越近，容量越小、速度越快、单元价格越贵，离CPU越远，容量越大，速度越慢，单元价格越便宜。
- 内存是架设在CPU与磁盘之间的桥梁，可将其视为磁盘的高速缓存，CPU的速度比磁盘快很多，内存填平了CPU和磁盘的速度鸿沟。
- 内存管理和优化对性能影响很大，是编写高性能程序的关键，但内存管理和优化牵扯很多系统底层知识，本章将梳理相关内容，从软硬件结合出发，力求简明扼要讲清楚这个主题的内容，如需更深入的理解，则需扩展阅读。

## CACHE
- 为什么需要CACHE？局部性原理
- 三级CACHE结构，L1-L2 CPU内core共享，L3 CPU独立
- 内存和CACHE的关系
- cache对性能的影响
	- 访问延迟对比
	- CacheLine
	- Cache miss / Cache hit，颠簸
- 分析和测量CACHE命中率
- 编写CACHE友好代码

## 虚拟存储
- 进程是执行中的程序，一个进程就是一个执行中的程序实例，同一个程序可以有多个执行中的实例。系统上同时运行的多个进程共享机器的CPU和内存资源，每个进程（线程）有一个独立的逻辑执行流，它提供一种假象，好像在独占的使用处理器；同时，它有一个私有地址空间，它提供另一个假象，好像在独占的使用存储器。
- 虚拟存储是一层抽象，它为每个进程提供了一致的、私有的地址空间，借助这一层关键抽象，计算机科学中最深刻最成功的概念“进程”才得以正常工作。
- 虚拟存储简化了存储器管理，链接器才得以以独立于内存物理地址的方式构建可执行程序。
- 虚拟存储是计算机系统的重要概念，理解好它便掌握了内存管理的钥匙。

内存可视为一个巨大的字节数组，每个元素占用一个字节，有自己的独立编号（地址）。应用程序中所使用的地址是虚拟地址（VA），这个虚拟地址在访问真正的物理内存的时候，需要被转换为物理地址（PA），虚拟地址到物理地址的转换过程叫地址翻译，CPU硬件和操作系统合作完成地址翻译，CPU芯片上的存储管理单元（MMU）查询内存中的页表动态完成地址翻译，而页表的内容由操作系统管理维护，这项工作由底层系统默默完成，应用程序无感知，但理解这个过程对掌握内存管理和优化技术至关重要。



### C进程内存布局
stack内存/heap内存

- 段页式内存管理
- MMU + 硬件合作
- page fault：minor page fault / major page fault
- segment fault
- 相关linux命令：pmap、vmstat、free，虚拟内存占用和RSS

## 动态内存分配
- 动态内存分配器的历史（多线程慢及改进）
- 动态内存分配器介于os与应用程序之间
- 内存碎片：内碎片 / 外碎片
- 动态内存分配器的目标
    - 高吞吐
	- 高有效内存使用率
	- 低时延
- 一次malloc要耗费多少cpu时间
- 几种经典的内存分配器：ptmalloc / tcmalloc / jemalloc
- 动态内存分配器的挑战（引出为什么需要MemPool）

## 内存池
- 为什么内存池更快？(因为放弃了中间free，本质上是以空间换时间)
- 批发转零售的策略
- 经典内存池的实现案例
	- Nginx内存池
	- doris内存池
	- loki小对象分配器
- 延伸：对象池

## 内存泄漏
何谓内存泄漏？动态申请的内存丢失引用
- C++ operator new/delete重载
- C wrap malloc/free
- 地址消毒器
- valgrind/cachegrind/asan

## 其他

- mmap
- Shared Memory
- 内存对齐及影响：posix\_memalign 
- 对内存的优化不应该作为项目的高优先级目标

## 参考资料

